<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Practice - HKDSE Physics AI Tutor</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/thinka.css">
    <link rel="stylesheet" href="css/ai-agent.css?v=6.3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/js/i18n.js"></script>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="user-info" id="userInfo">
                    <div class="user-name" id="userName">Guest</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/"><i class="fas fa-home"></i> <span data-i18n="nav.dashboard">Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="/ai-tutor.html"><i class="fas fa-robot"></i> <span data-i18n="nav.aiTutor">AI
                            Tutor</span></a>
                </li>
                <li class="nav-item active">
                    <a href="/free-practice.html"><i class="fas fa-pen"></i> <span data-i18n="nav.freePractice">Free
                            Practice</span></a>
                </li>
                <li class="nav-item">
                    <a href="/statistics.html"><i class="fas fa-chart-bar"></i> <span
                            data-i18n="nav.statistics">Statistics</span></a>
                </li>
                <li class="nav-item">
                    <a href="/practice-history.html"><i class="fas fa-history"></i> <span
                            data-i18n="nav.history">History</span></a>
                </li>
                <li class="nav-item">
                    <a href="/bookmarks.html"><i class="fas fa-bookmark"></i> <span
                            data-i18n="nav.bookmarks">Bookmarks</span></a>
                </li>
                <li class="nav-item">
                    <a href="/leaderboard.html"><i class="fas fa-trophy"></i> <span
                            data-i18n="nav.leaderboard">Leaderboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="/profile.html"><i class="fas fa-user"></i> <span data-i18n="nav.profile">Profile</span></a>
                </li>
                <li class="nav-item admin-only" id="adminNavItem" hidden>
                    <a href="/admin.html"><i class="fas fa-cog"></i> <span data-i18n="nav.adminPanel">Admin
                            Panel</span></a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <div class="language-switcher-container" id="langSwitcherContainer"></div>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="nav.signOut">Sign Out</span>
                </button>
                <div class="version">v1.0.0</div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header animate-on-scroll fade-in-up">
                <h1>Free Practice</h1>
                <div class="header-tabs">
                    <button class="tab-btn active">SELECT CHAPTERS</button>
                </div>
            </header>

            <div class="config-section animate-on-scroll fade-in-up">
                <!-- Subject and Language -->
                <div class="config-row">
                    <div class="config-item">
                        <label>Category</label>
                        <select id="categorySelect" disabled>
                            <option>Senior Secondary (HKDSE)</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>Subject</label>
                        <select id="subjectSelect">
                            <option value="Physics">Physics 物理</option>
                            <option value="Mathematics">Mathematics 數學</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>Language</label>
                        <select id="languageSelect">
                            <option value="zh">中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>

                <!-- Question Counts -->
                <div class="config-row">
                    <div class="config-item">
                        <label>MC Questions <span id="mcLimitLabel" class="limit-badge">(0 - 10)</span></label>
                        <input type="number" id="mcCount" min="0" max="10" value="3">
                    </div>
                    <div class="config-item">
                        <label>Short Questions <span id="shortLimitLabel" class="limit-badge">(0 - 5)</span></label>
                        <input type="number" id="shortCount" min="0" max="5" value="2">
                    </div>
                    <div class="config-item">
                        <label>Long Questions <span id="longLimitLabel" class="limit-badge">(0 - 3)</span></label>
                        <input type="number" id="longCount" min="0" max="3" value="1">
                    </div>
                </div>

                <!-- Time and Difficulty -->
                <div class="config-row">
                    <div class="config-item">
                        <label>Time Limit (1 - 120min)</label>
                        <input type="number" id="timeLimit" min="1" max="120" value="30">
                    </div>
                    <div class="config-item">
                        <label>Difficulty</label>
                        <div class="difficulty-stars" id="difficultyStars">
                            <span class="star active" data-value="1">★</span>
                            <span class="star active" data-value="2">★</span>
                            <span class="star active" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topics Selection -->
            <div class="topics-section" id="topicsSection">
                <!-- Topics will be rendered here by JavaScript -->
            </div>

            <!-- Start Button -->
            <div class="action-section animate-on-scroll scale-in">
                <button class="btn-start btn-glow ripple shine" id="startBtn">
                    <i class="fas fa-play"></i> 開始練習 START
                </button>
            </div>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay" hidden>
                <div class="loading-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在生成題目...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let selectedDifficulty = 3;
        let selectedTopics = new Set();
        let isGenerating = false; // Prevent double-trigger lock
        let poolLimits = { mc: 10, short: 5, long: 3 }; // Default limits
        let poolAvailability = { mc: { en: 0, zh: 0 }, short: { en: 0, zh: 0 }, long: { en: 0, zh: 0 } };

        // Force hide loading overlay on page load (fallback)
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.hidden = true;
        }

        // Handle bfcache (back/forward navigation) - ensure overlay is hidden
        window.addEventListener('pageshow', hideLoadingOverlay);

        // Topics data - Physics
        const PHYSICS_TOPICS = {
            heat_gas: {
                id: 'heat_gas',
                name: '熱與氣體',
                color: '#ef4444',
                subtopics: [
                    { id: 'heat_1', name: '溫度、熱及內能' },
                    { id: 'heat_2', name: '傳導、對流、輻射' },
                    { id: 'heat_3', name: '物態轉變與潛熱' },
                    { id: 'heat_4', name: '氣體定律與動理學理論' }
                ]
            },
            mechanics: {
                id: 'mechanics',
                name: '力和運動',
                color: '#3b82f6',
                subtopics: [
                    { id: 'mech_1', name: '位移與運動學' },
                    { id: 'mech_2', name: '牛頓定律' },
                    { id: 'mech_3', name: '拋體運動' },
                    { id: 'mech_4', name: '作功、能量和功率' },
                    { id: 'mech_5', name: '動量' },
                    { id: 'mech_6', name: '圓周運動與重力' }
                ]
            },
            waves: {
                id: 'waves',
                name: '波動',
                color: '#8b5cf6',
                subtopics: [
                    { id: 'wave_1', name: '波的本質和特性' },
                    { id: 'wave_2', name: '光的反射、折射、繞射與透鏡' },
                    { id: 'wave_3', name: '聲波' }
                ]
            },
            electricity: {
                id: 'electricity',
                name: '電和磁',
                color: '#f59e0b',
                subtopics: [
                    { id: 'elec_1', name: '靜電學' },
                    { id: 'elec_2', name: '電路' },
                    { id: 'elec_3', name: '電磁感應' },
                    { id: 'elec_4', name: '交流電' }
                ]
            },
            radioactivity: {
                id: 'radioactivity',
                name: '放射現象和核能',
                color: '#22c55e',
                subtopics: [
                    { id: 'radio_1', name: '放射性衰變' },
                    { id: 'radio_2', name: '核反應' },
                    { id: 'radio_3', name: '核能應用' }
                ]
            },
            astronomy: {
                id: 'astronomy',
                name: '天文學和航天科學',
                color: '#06b6d4',
                subtopics: [
                    { id: 'astro_1', name: '太陽系' },
                    { id: 'astro_2', name: '恆星' },
                    { id: 'astro_3', name: '宇宙學' }
                ]
            }
        };

        // Topics data - Mathematics (based on official HKDSE curriculum)
        const MATH_TOPICS = {
            // Compulsory Part
            number_algebra: {
                id: 'number_algebra',
                name: '數與代數',
                color: '#3b82f6',
                subtopics: [
                    { id: 'math_na_1', name: '指數定律' },
                    { id: 'math_na_2', name: '多項式' },
                    { id: 'math_na_3', name: '因式分解' },
                    { id: 'math_na_4', name: '二次方程' },
                    { id: 'math_na_5', name: '函數及其圖像' },
                    { id: 'math_na_6', name: '指數函數與對數函數' },
                    { id: 'math_na_7', name: '等差數列與等比數列' },
                    { id: 'math_na_8', name: '不等式' },
                    { id: 'math_na_9', name: '線性規劃' },
                    { id: 'math_na_10', name: '變分' }
                ]
            },
            geometry: {
                id: 'geometry',
                name: '度量、圖形與空間',
                color: '#8b5cf6',
                subtopics: [
                    { id: 'math_geo_1', name: '直線方程' },
                    { id: 'math_geo_2', name: '圓的方程' },
                    { id: 'math_geo_3', name: '軌跡' },
                    { id: 'math_geo_4', name: '演繹幾何' },
                    { id: 'math_geo_5', name: '平面圖形的面積與周界' },
                    { id: 'math_geo_6', name: '立體圖形' },
                    { id: 'math_geo_7', name: '三維圖形的體積與表面積' },
                    { id: 'math_geo_8', name: '相似與全等' }
                ]
            },
            trigonometry: {
                id: 'trigonometry',
                name: '三角學',
                color: '#ef4444',
                subtopics: [
                    { id: 'math_trig_1', name: '三角比' },
                    { id: 'math_trig_2', name: '三角函數的圖像' },
                    { id: 'math_trig_3', name: '三角恆等式' },
                    { id: 'math_trig_4', name: '解三角形' },
                    { id: 'math_trig_5', name: '弧度制與扇形' },
                    { id: 'math_trig_6', name: '二維與三維問題' }
                ]
            },
            statistics: {
                id: 'statistics',
                name: '數據處理',
                color: '#22c55e',
                subtopics: [
                    { id: 'math_stat_1', name: '統計的表達方式' },
                    { id: 'math_stat_2', name: '集中趨勢的量度' },
                    { id: 'math_stat_3', name: '離差的量度' },
                    { id: 'math_stat_4', name: '概率' },
                    { id: 'math_stat_5', name: '排列與組合' }
                ]
            },
            // Extended Part M1
            calculus_m1: {
                id: 'calculus_m1',
                name: 'M1 微積分與統計',
                color: '#f59e0b',
                subtopics: [
                    { id: 'math_m1_1', name: '二項式展開' },
                    { id: 'math_m1_2', name: '極限與微分' },
                    { id: 'math_m1_3', name: '微分的應用' },
                    { id: 'math_m1_4', name: '積分' },
                    { id: 'math_m1_5', name: '定積分的應用' },
                    { id: 'math_m1_6', name: '離散隨機變量' },
                    { id: 'math_m1_7', name: '二項分佈' },
                    { id: 'math_m1_8', name: '正態分佈' },
                    { id: 'math_m1_9', name: '抽樣分佈與估計' }
                ]
            },
            // Extended Part M2
            algebra_m2: {
                id: 'algebra_m2',
                name: 'M2 代數與微積分',
                color: '#06b6d4',
                subtopics: [
                    { id: 'math_m2_1', name: '數學歸納法' },
                    { id: 'math_m2_2', name: '二項式定理' },
                    { id: 'math_m2_3', name: '三角學進階' },
                    { id: 'math_m2_4', name: 'e 和自然對數' },
                    { id: 'math_m2_5', name: '極限' },
                    { id: 'math_m2_6', name: '微分法' },
                    { id: 'math_m2_7', name: '微分的應用' },
                    { id: 'math_m2_8', name: '不定積分' },
                    { id: 'math_m2_9', name: '定積分' },
                    { id: 'math_m2_10', name: '定積分的應用' },
                    { id: 'math_m2_11', name: '矩陣' },
                    { id: 'math_m2_12', name: '線性方程組' },
                    { id: 'math_m2_13', name: '向量' }
                ]
            }
        };

        // Get current topics based on selected subject
        function getCurrentTopics() {
            const subject = document.getElementById('subjectSelect').value;
            return subject === 'Mathematics' ? MATH_TOPICS : PHYSICS_TOPICS;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Force hide loading overlay immediately on page load
            hideLoadingOverlay();

            // Initialize i18n first
            await window.i18n.initI18n();
            window.i18n.createLanguageSwitcher('langSwitcherContainer');

            // Listen for language changes to re-render topics
            window.addEventListener('languageChanged', () => {
                renderTopics();
            });

            await checkAuth();
            await fetchPoolAvailability();
            renderTopics();
            initEventListeners();
            initScrollAnimations();
        });

        // Initialize scroll animations using IntersectionObserver
        function initScrollAnimations() {
            const animatedElements = document.querySelectorAll('.animate-on-scroll:not(.visible)');

            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });

                animatedElements.forEach(el => observer.observe(el));
            } else {
                // Fallback for browsers without IntersectionObserver
                animatedElements.forEach(el => el.classList.add('visible'));
            }
        }

        async function fetchPoolAvailability() {
            try {
                const response = await fetch(`${API_BASE}/quiz/pool-availability`);
                if (response.ok) {
                    const data = await response.json();
                    poolAvailability = data.availability;
                    poolLimits = data.limits;
                    updateLimitsUI();
                }
            } catch (err) {
                console.error('Failed to fetch pool availability:', err);
                // Use defaults
                updateLimitsUI();
            }
        }

        function updateLimitsUI() {
            const language = document.getElementById('languageSelect').value;

            // Get limits for current language
            const mcMax = poolLimits.mc?.[language] || 10;
            const shortMax = poolLimits.short?.[language] || 5;
            const longMax = poolLimits.long?.[language] || 3;

            // Update labels
            document.getElementById('mcLimitLabel').textContent = `(0 - ${mcMax})`;
            document.getElementById('shortLimitLabel').textContent = `(0 - ${shortMax})`;
            document.getElementById('longLimitLabel').textContent = `(0 - ${longMax})`;

            // Update input max values
            const mcInput = document.getElementById('mcCount');
            const shortInput = document.getElementById('shortCount');
            const longInput = document.getElementById('longCount');

            mcInput.max = mcMax;
            shortInput.max = shortMax;
            longInput.max = longMax;

            // Clamp current values if exceeds new max
            if (parseInt(mcInput.value) > mcMax) mcInput.value = mcMax;
            if (parseInt(shortInput.value) > shortMax) shortInput.value = shortMax;
            if (parseInt(longInput.value) > longMax) longInput.value = longMax;

        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    // Handle both { user: {...} } and flat { email, name } formats
                    currentUser = data.user || data;

                    if (currentUser && currentUser.email) {
                        document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0] || 'User';
                        document.getElementById('userEmail').textContent = currentUser.email;
                        checkAdminAccess();
                    } else {
                        // No valid user data - redirect to login
                        window.location.href = '/login.html';
                    }
                } else {
                    // Not logged in - redirect to login page
                    window.location.href = '/login.html';
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                // On network error, still show page but user may need to login
                document.getElementById('userName').textContent = 'Guest';
            }
        }

        async function checkAdminAccess() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, { credentials: 'include' });
                if (response.ok) {
                    const adminNav = document.getElementById('adminNavItem');
                    if (adminNav) adminNav.hidden = false;
                }
            } catch (err) { /* Not admin */ }
        }

        function renderTopics() {
            const container = document.getElementById('topicsSection');
            const t = window.i18n ? window.i18n.t : (key) => key;
            const topics = getCurrentTopics();

            container.innerHTML = Object.values(topics).map((topic, index) => {
                // Get translated topic name, fallback to original
                const topicName = t(`topics.${topic.id}`) !== `topics.${topic.id}` ? t(`topics.${topic.id}`) : topic.name;

                return `
                <div class="topic-card card-lift animate-on-scroll fade-in-up stagger-${(index % 6) + 1}" style="--topic-color: ${topic.color}">
                    <div class="topic-header" style="border-color: ${topic.color}">
                        <span>${topicName}</span>
                    </div>
                    <div class="topic-subtopics">
                        ${topic.subtopics.map((sub, i) => {
                    // Get translated subtopic name, fallback to original
                    const subName = t(`topics.${sub.id}`) !== `topics.${sub.id}` ? t(`topics.${sub.id}`) : sub.name;
                    return `
                            <label class="subtopic-item checkbox-animated">
                                <input type="checkbox" value="${sub.id}" onchange="toggleTopic('${sub.id}')" ${selectedTopics.has(sub.id) ? 'checked' : ''}>
                                <span>${i + 1}. ${subName}</span>
                            </label>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');

            // Re-initialize scroll animations for dynamically added elements
            initScrollAnimations();
        }

        function toggleTopic(topicId) {
            if (selectedTopics.has(topicId)) {
                selectedTopics.delete(topicId);
            } else {
                selectedTopics.add(topicId);
            }
        }

        function initEventListeners() {
            // Difficulty stars
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', () => {
                    selectedDifficulty = parseInt(star.dataset.value);
                    updateDifficultyStars();
                });
            });

            // Language change - update limits
            document.getElementById('languageSelect').addEventListener('change', updateLimitsUI);

            // Subject change - re-render topics and clear selection
            document.getElementById('subjectSelect').addEventListener('change', () => {
                selectedTopics.clear();
                renderTopics();
            });

            // Start button
            document.getElementById('startBtn').addEventListener('click', startQuiz);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
                window.location.href = '/';
            });
        }

        function updateDifficultyStars() {
            document.querySelectorAll('.star').forEach(star => {
                const value = parseInt(star.dataset.value);
                star.classList.toggle('active', value <= selectedDifficulty);
            });
        }

        async function startQuiz() {
            // Prevent double-trigger
            if (isGenerating) return;

            const mcCount = parseInt(document.getElementById('mcCount').value) || 0;
            const shortCount = parseInt(document.getElementById('shortCount').value) || 0;
            const longCount = parseInt(document.getElementById('longCount').value) || 0;
            const timeLimit = parseInt(document.getElementById('timeLimit').value) || 30;
            const language = document.getElementById('languageSelect').value;
            const subject = document.getElementById('subjectSelect').value;

            if (selectedTopics.size === 0) {
                alert('請選擇至少一個章節 / Please select at least one topic');
                return;
            }

            if (mcCount + shortCount + longCount === 0) {
                alert('請設置題目數量 / Please set question count');
                return;
            }

            isGenerating = true;
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.hidden = false;

            try {
                const response = await fetch(`${API_BASE}/quiz/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        topics: Array.from(selectedTopics),
                        subject, // Physics or Mathematics
                        mcCount,
                        shortCount,
                        longCount,
                        difficulty: selectedDifficulty,
                        timeLimit,
                        language,
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate quiz');
                }

                const data = await response.json();

                // Store session data and redirect to working page
                sessionStorage.setItem('quizSession', JSON.stringify(data));
                window.location.href = `/working.html?session=${data.sessionId}`;

            } catch (err) {
                console.error('Failed to start quiz:', err);
                alert(err.message || '生成題目失敗，請重試');
            } finally {
                loadingOverlay.hidden = true;
                isGenerating = false;
            }
        }
    </script>
    <!-- AI Agent - Lancelot Assistant -->
    <script src="/js/physics-avatar.js?v=6.3"></script>
    <script src="/js/ai-agent.js?v=6.3"></script>
</body>

</html>
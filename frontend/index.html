<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics AI Tutor</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/thinka.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/ai-agent.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/js/i18n.js"></script>
</head>

<body>
    <!-- Particles Background -->
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="user-info" id="userInfo">
                    <div class="user-name" id="userName">Guest</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active">
                    <a href="/"><i class="fas fa-home"></i> <span data-i18n="nav.dashboard">Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="/ai-tutor.html"><i class="fas fa-robot"></i> <span data-i18n="nav.aiTutor">AI
                            Tutor</span></a>
                </li>
                <li class="nav-item">
                    <a href="/free-practice.html"><i class="fas fa-pen"></i> <span data-i18n="nav.freePractice">Free
                            Practice</span></a>
                </li>
                <li class="nav-item">
                    <a href="/statistics.html"><i class="fas fa-chart-bar"></i> <span
                            data-i18n="nav.statistics">Statistics</span></a>
                </li>
                <li class="nav-item">
                    <a href="/practice-history.html"><i class="fas fa-history"></i> <span
                            data-i18n="nav.history">History</span></a>
                </li>
                <li class="nav-item">
                    <a href="/bookmarks.html"><i class="fas fa-bookmark"></i> <span
                            data-i18n="nav.bookmarks">Bookmarks</span></a>
                </li>
                <li class="nav-item">
                    <a href="/leaderboard.html"><i class="fas fa-trophy"></i> <span
                            data-i18n="nav.leaderboard">Leaderboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="/profile.html"><i class="fas fa-user"></i> <span data-i18n="nav.profile">Profile</span></a>
                </li>
                <li class="nav-item admin-only" id="adminNavItem" hidden>
                    <a href="/admin.html"><i class="fas fa-cog"></i> <span data-i18n="nav.adminPanel">Admin
                            Panel</span></a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <div class="language-switcher-container" id="langSwitcherContainer"></div>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="nav.signOut">Sign Out</span>
                </button>
                <div class="version">v2.0.0</div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Section -->
            <header class="dashboard-header gradient-bg-hero animate-on-scroll fade-in-up">
                <div class="welcome-text">
                    <h1 id="welcomeTitle">Welcome back, <span id="welcomeName">Student</span>!</h1>
                    <p data-i18n="dashboard.readyToMaster">Ready to master HKDSE Physics?</p>
                </div>
                <div class="header-actions">
                    <button class="btn-login btn-glow ripple" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> <span data-i18n="common.login">Login</span>
                    </button>
                </div>
            </header>

            <!-- Quick Stats -->
            <section class="quick-stats" id="quickStats">
                <div class="quick-stat-card card-lift icon-bounce animate-on-scroll scale-in stagger-1">
                    <i class="fas fa-fire"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statStreak">0</span>
                        <span class="stat-label" data-i18n="dashboard.dayStreak">Day Streak</span>
                    </div>
                </div>
                <div class="quick-stat-card card-lift icon-bounce animate-on-scroll scale-in stagger-2">
                    <i class="fas fa-star"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statPoints">0</span>
                        <span class="stat-label" data-i18n="dashboard.totalPoints">Total Points</span>
                    </div>
                </div>
                <div class="quick-stat-card card-lift icon-bounce animate-on-scroll scale-in stagger-3">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statQuestions">0</span>
                        <span class="stat-label" data-i18n="dashboard.questionsDone">Questions Done</span>
                    </div>
                </div>
                <div class="quick-stat-card card-lift icon-bounce animate-on-scroll scale-in stagger-4">
                    <i class="fas fa-medal"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statRank">#--</span>
                        <span class="stat-label" data-i18n="dashboard.globalRank">Global Rank</span>
                    </div>
                </div>
            </section>

            <!-- Main Feature Cards -->
            <section class="feature-cards">
                <a href="/ai-tutor.html"
                    class="feature-card ai-tutor-card tilt-card shine animate-on-scroll fade-in-left">
                    <div class="card-icon icon-bounce">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="card-content">
                        <h2 data-i18n="features.aiTutor.title">AI Tutor</h2>
                        <p data-i18n="features.aiTutor.description">Upload question photos or enter text for DSE-style
                            step-by-step explanations</p>
                        <ul class="card-features">
                            <li><i class="fas fa-check"></i> <span data-i18n="features.aiTutor.feature1">Image/Text
                                    Q&A</span></li>
                            <li><i class="fas fa-check"></i> <span data-i18n="features.aiTutor.feature2">Multiple AI
                                    Models</span></li>
                            <li><i class="fas fa-check"></i> <span data-i18n="features.aiTutor.feature3">Socratic
                                    Guidance Mode</span></li>
                        </ul>
                    </div>
                    <div class="card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>

                <a href="/free-practice.html"
                    class="feature-card practice-card tilt-card shine animate-on-scroll fade-in-right">
                    <div class="card-icon icon-bounce">
                        <i class="fas fa-pen"></i>
                    </div>
                    <div class="card-content">
                        <h2 data-i18n="features.freePractice.title">Free Practice</h2>
                        <p data-i18n="features.freePractice.description">Select chapters and difficulty, start practice
                            quizzes</p>
                        <ul class="card-features">
                            <li><i class="fas fa-check"></i> <span data-i18n="features.freePractice.feature1">MC / Short
                                    / Long Questions</span></li>
                            <li><i class="fas fa-check"></i> <span data-i18n="features.freePractice.feature2">AI
                                    Auto-generated Questions</span></li>
                            <li><i class="fas fa-check"></i> <span data-i18n="features.freePractice.feature3">Instant
                                    Scoring and Feedback</span></li>
                        </ul>
                    </div>
                    <div class="card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </section>

            <!-- Secondary Cards -->
            <section class="secondary-cards">
                <a href="/statistics.html"
                    class="secondary-card card-lift icon-bounce animate-on-scroll fade-in-up stagger-1">
                    <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
                    <h3 data-i18n="nav.statistics">Statistics</h3>
                    <p data-i18n="statistics.overview">Overview</p>
                </a>
                <a href="/leaderboard.html"
                    class="secondary-card card-lift icon-bounce animate-on-scroll fade-in-up stagger-2">
                    <div class="card-icon"><i class="fas fa-trophy"></i></div>
                    <h3 data-i18n="nav.leaderboard">Leaderboard</h3>
                    <p data-i18n="leaderboard.topPlayers">Top Players</p>
                </a>
                <a href="/bookmarks.html"
                    class="secondary-card card-lift icon-bounce animate-on-scroll fade-in-up stagger-3">
                    <div class="card-icon"><i class="fas fa-bookmark"></i></div>
                    <h3 data-i18n="nav.bookmarks">Bookmarks</h3>
                    <p data-i18n="bookmarks.saveQuestions">Save questions you want to review later</p>
                </a>
                <a href="/practice-history.html"
                    class="secondary-card card-lift icon-bounce animate-on-scroll fade-in-up stagger-4">
                    <div class="card-icon"><i class="fas fa-history"></i></div>
                    <h3 data-i18n="nav.history">History</h3>
                    <p data-i18n="history.viewDetails">View Details</p>
                </a>
            </section>

            <!-- Recent Activity -->
            <section class="recent-activity animate-on-scroll fade-in-up" id="recentActivity">
                <h2><i class="fas fa-clock"></i> <span data-i18n="dashboard.recentActivity">Recent Activity</span></h2>
                <div class="activity-list" id="activityList">
                    <p class="empty-state" data-i18n="dashboard.loginToSeeActivity">Login to see your recent activity
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" hidden>
        <div class="modal-content">
            <button class="modal-close" id="closeLoginModal">&times;</button>
            <h2><i class="fas fa-user-circle"></i> 登入帳戶</h2>
            <p>登入後可同步歷史記錄到雲端，跨設備使用</p>
            <button class="btn-google" id="googleLoginBtn">
                <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                用 Google 帳號登入
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize i18n first
            await window.i18n.initI18n();
            window.i18n.createLanguageSwitcher('langSwitcherContainer');

            await checkAuth();
            initEventListeners();
            initScrollAnimations();

            // Check for login redirect - go to login page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login') === 'true' && !currentUser) {
                window.location.href = '/login.html';
            }
        });

        // Initialize scroll animations using IntersectionObserver
        function initScrollAnimations() {
            const animatedElements = document.querySelectorAll('.animate-on-scroll');

            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });

                animatedElements.forEach(el => observer.observe(el));
            } else {
                // Fallback for browsers without IntersectionObserver
                animatedElements.forEach(el => el.classList.add('visible'));
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    // Extract user from response - API returns { user: {...} }
                    currentUser = data.user;
                    if (currentUser && currentUser.email) {
                        updateUIForLoggedInUser();
                        loadUserStats();
                        loadRecentActivity();
                    } else {
                        updateUIForGuest();
                    }
                } else {
                    updateUIForGuest();
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                updateUIForGuest();
            }
        }

        function updateUIForLoggedInUser() {
            const name = currentUser.name || currentUser.email?.split('@')[0] || 'Student';
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email || '';
            document.getElementById('welcomeName').textContent = name;
            document.getElementById('welcomeTitle').innerHTML = window.i18n.t('dashboard.welcome', { name: `<span id="welcomeName">${name}</span>` });
            document.getElementById('loginBtn').hidden = true;
            document.getElementById('logoutBtn').hidden = false;

            // Set language from user preference if logged in
            if (currentUser.language && currentUser.language !== window.i18n.getLanguage()) {
                window.i18n.setLanguage(currentUser.language);
            }

            // Check if user is admin (lightweight check)
            checkAdminAccess();
        }

        async function checkAdminAccess() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    credentials: 'include',
                    method: 'GET'
                });
                if (response.ok) {
                    // User is admin, show admin nav
                    const adminNav = document.getElementById('adminNavItem');
                    if (adminNav) adminNav.hidden = false;
                }
            } catch (err) {
                // Not admin or error, keep hidden
            }
        }

        function updateUIForGuest() {
            document.getElementById('userName').textContent = window.i18n.t('common.guest');
            document.getElementById('userEmail').textContent = '';
            document.getElementById('welcomeTitle').textContent = window.i18n.t('dashboard.welcomeGuest');
            document.getElementById('loginBtn').hidden = false;
            document.getElementById('logoutBtn').hidden = true;
        }

        async function loadUserStats() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE}/user/stats`, { credentials: 'include' });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('statStreak').textContent = stats.current_streak || 0;
                    document.getElementById('statPoints').textContent = stats.total_points || 0;
                    document.getElementById('statQuestions').textContent = stats.total_attempts || 0;
                    document.getElementById('statRank').textContent = stats.rank ? `#${stats.rank}` : '#--';
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadRecentActivity() {
            if (!currentUser) return;

            const activityList = document.getElementById('activityList');

            try {
                const response = await fetch(`${API_BASE}/quiz/history?limit=5`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.sessions && data.sessions.length > 0) {
                        activityList.innerHTML = data.sessions.map(s => `
                            <div class="activity-item" onclick="window.location.href='/quiz-review.html?session=${s.id}'">
                                <div class="activity-icon">
                                    <i class="fas fa-pen"></i>
                                </div>
                                <div class="activity-info">
                                    <span class="activity-title">Practice Quiz</span>
                                    <span class="activity-meta">${s.questionCount} questions · Grade ${s.grade}</span>
                                </div>
                                <div class="activity-date">${formatDate(s.createdAt)}</div>
                            </div>
                        `).join('');
                    } else {
                        activityList.innerHTML = '<p class="empty-state">No recent activity. Start practicing!</p>';
                    }
                }
            } catch (err) {
                console.error('Failed to load activity:', err);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function initEventListeners() {
            // Login button - redirect to dedicated login page
            document.getElementById('loginBtn').addEventListener('click', () => {
                window.location.href = '/login.html';
            });

            // Close modal (keep for backwards compatibility)
            const closeBtn = document.getElementById('closeLoginModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById('loginModal').hidden = true;
                });
            }

            // Google login in modal (if exists)
            const googleBtn = document.getElementById('googleLoginBtn');
            if (googleBtn) {
                googleBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`${API_BASE}/auth/google/url`);
                        const data = await response.json();
                        if (response.ok && data.url) {
                            window.location.href = data.url;
                        }
                    } catch (err) {
                        console.error('OAuth error:', err);
                    }
                });
            }

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
                window.location.reload();
            });

            // Click outside modal to close
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.addEventListener('click', (e) => {
                    if (e.target.id === 'loginModal') {
                        loginModal.hidden = true;
                    }
                });
            }
        }
    </script>
    <!-- AI Agent - Lancelot Assistant -->
    <script src="/js/ai-agent.js?v=2.0"></script>
</body>

</html>
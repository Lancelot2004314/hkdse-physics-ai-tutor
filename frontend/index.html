<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics AI Tutor</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/thinka.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="user-info" id="userInfo">
                    <div class="user-name" id="userName">Guest</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active">
                    <a href="/"><i class="fas fa-home"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="/ai-tutor.html"><i class="fas fa-robot"></i> AI Tutor</a>
                </li>
                <li class="nav-item">
                    <a href="/free-practice.html"><i class="fas fa-pen"></i> Free Practice</a>
                </li>
                <li class="nav-item">
                    <a href="/statistics.html"><i class="fas fa-chart-bar"></i> Statistics</a>
                </li>
                <li class="nav-item">
                    <a href="/practice-history.html"><i class="fas fa-history"></i> History</a>
                </li>
                <li class="nav-item">
                    <a href="/bookmarks.html"><i class="fas fa-bookmark"></i> Bookmarks</a>
                </li>
                <li class="nav-item">
                    <a href="/leaderboard.html"><i class="fas fa-trophy"></i> Leaderboard</a>
                </li>
                <li class="nav-item">
                    <a href="/profile.html"><i class="fas fa-user"></i> Profile</a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
                <div class="version">v2.0.0</div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Section -->
            <header class="dashboard-header">
                <div class="welcome-text">
                    <h1>Welcome back, <span id="welcomeName">Student</span>!</h1>
                    <p>Ready to master HKDSE Physics?</p>
                </div>
                <div class="header-actions">
                    <button class="btn-login" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </header>

            <!-- Quick Stats -->
            <section class="quick-stats" id="quickStats">
                <div class="quick-stat-card">
                    <i class="fas fa-fire"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statStreak">0</span>
                        <span class="stat-label">Day Streak</span>
                    </div>
                </div>
                <div class="quick-stat-card">
                    <i class="fas fa-star"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statPoints">0</span>
                        <span class="stat-label">Total Points</span>
                    </div>
                </div>
                <div class="quick-stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statQuestions">0</span>
                        <span class="stat-label">Questions Done</span>
                    </div>
                </div>
                <div class="quick-stat-card">
                    <i class="fas fa-medal"></i>
                    <div class="stat-info">
                        <span class="stat-value" id="statRank">#--</span>
                        <span class="stat-label">Global Rank</span>
                    </div>
                </div>
            </section>

            <!-- Main Feature Cards -->
            <section class="feature-cards">
                <a href="/ai-tutor.html" class="feature-card ai-tutor-card">
                    <div class="card-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="card-content">
                        <h2>AI Tutor</h2>
                        <p>上傳題目照片或輸入文字，獲得 DSE 風格分步講解</p>
                        <ul class="card-features">
                            <li><i class="fas fa-check"></i> 圖片/文字問答</li>
                            <li><i class="fas fa-check"></i> 多種 AI 模型</li>
                            <li><i class="fas fa-check"></i> 蘇格拉底引導模式</li>
                        </ul>
                    </div>
                    <div class="card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>

                <a href="/free-practice.html" class="feature-card practice-card">
                    <div class="card-icon">
                        <i class="fas fa-pen"></i>
                    </div>
                    <div class="card-content">
                        <h2>Free Practice</h2>
                        <p>選擇章節和難度，開始練習測驗</p>
                        <ul class="card-features">
                            <li><i class="fas fa-check"></i> MC / 簡答 / 長答題</li>
                            <li><i class="fas fa-check"></i> AI 自動生成題目</li>
                            <li><i class="fas fa-check"></i> 即時評分和反饋</li>
                        </ul>
                    </div>
                    <div class="card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </section>

            <!-- Secondary Cards -->
            <section class="secondary-cards">
                <a href="/statistics.html" class="secondary-card">
                    <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
                    <h3>Statistics</h3>
                    <p>查看學習統計和進度</p>
                </a>
                <a href="/leaderboard.html" class="secondary-card">
                    <div class="card-icon"><i class="fas fa-trophy"></i></div>
                    <h3>Leaderboard</h3>
                    <p>查看排行榜</p>
                </a>
                <a href="/bookmarks.html" class="secondary-card">
                    <div class="card-icon"><i class="fas fa-bookmark"></i></div>
                    <h3>Bookmarks</h3>
                    <p>查看收藏的題目</p>
                </a>
                <a href="/practice-history.html" class="secondary-card">
                    <div class="card-icon"><i class="fas fa-history"></i></div>
                    <h3>History</h3>
                    <p>查看練習歷史</p>
                </a>
            </section>

            <!-- Recent Activity -->
            <section class="recent-activity" id="recentActivity">
                <h2><i class="fas fa-clock"></i> Recent Activity</h2>
                <div class="activity-list" id="activityList">
                    <p class="empty-state">Login to see your recent activity</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" hidden>
        <div class="modal-content">
            <button class="modal-close" id="closeLoginModal">&times;</button>
            <h2><i class="fas fa-user-circle"></i> 登入帳戶</h2>
            <p>登入後可同步歷史記錄到雲端，跨設備使用</p>
            <button class="btn-google" id="googleLoginBtn">
                <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                用 Google 帳號登入
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            initEventListeners();

            // Check for login redirect - go to login page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login') === 'true' && !currentUser) {
                window.location.href = '/login.html';
            }
        });

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    // Extract user from response - API returns { user: {...} }
                    currentUser = data.user;
                    if (currentUser && currentUser.email) {
                        updateUIForLoggedInUser();
                        loadUserStats();
                        loadRecentActivity();
                    } else {
                        updateUIForGuest();
                    }
                } else {
                    updateUIForGuest();
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                updateUIForGuest();
            }
        }

        function updateUIForLoggedInUser() {
            const name = currentUser.name || currentUser.email?.split('@')[0] || 'Student';
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email || '';
            document.getElementById('welcomeName').textContent = name;
            document.getElementById('loginBtn').hidden = true;
            document.getElementById('logoutBtn').hidden = false;
        }

        function updateUIForGuest() {
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userEmail').textContent = '';
            document.getElementById('welcomeName').textContent = 'Student';
            document.getElementById('loginBtn').hidden = false;
            document.getElementById('logoutBtn').hidden = true;
        }

        async function loadUserStats() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE}/user/stats`, { credentials: 'include' });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('statStreak').textContent = stats.current_streak || 0;
                    document.getElementById('statPoints').textContent = stats.total_points || 0;
                    document.getElementById('statQuestions').textContent = stats.total_attempts || 0;
                    document.getElementById('statRank').textContent = stats.rank ? `#${stats.rank}` : '#--';
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadRecentActivity() {
            if (!currentUser) return;

            const activityList = document.getElementById('activityList');

            try {
                const response = await fetch(`${API_BASE}/quiz/history?limit=5`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.sessions && data.sessions.length > 0) {
                        activityList.innerHTML = data.sessions.map(s => `
                            <div class="activity-item" onclick="window.location.href='/quiz-review.html?session=${s.id}'">
                                <div class="activity-icon">
                                    <i class="fas fa-pen"></i>
                                </div>
                                <div class="activity-info">
                                    <span class="activity-title">Practice Quiz</span>
                                    <span class="activity-meta">${s.questionCount} questions · Grade ${s.grade}</span>
                                </div>
                                <div class="activity-date">${formatDate(s.createdAt)}</div>
                            </div>
                        `).join('');
                    } else {
                        activityList.innerHTML = '<p class="empty-state">No recent activity. Start practicing!</p>';
                    }
                }
            } catch (err) {
                console.error('Failed to load activity:', err);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function initEventListeners() {
            // Login button - redirect to dedicated login page
            document.getElementById('loginBtn').addEventListener('click', () => {
                window.location.href = '/login.html';
            });

            // Close modal (keep for backwards compatibility)
            const closeBtn = document.getElementById('closeLoginModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById('loginModal').hidden = true;
                });
            }

            // Google login in modal (if exists)
            const googleBtn = document.getElementById('googleLoginBtn');
            if (googleBtn) {
                googleBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`${API_BASE}/auth/google/url`);
                        const data = await response.json();
                        if (response.ok && data.url) {
                            window.location.href = data.url;
                        }
                    } catch (err) {
                        console.error('OAuth error:', err);
                    }
                });
            }

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
                window.location.reload();
            });

            // Click outside modal to close
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.addEventListener('click', (e) => {
                    if (e.target.id === 'loginModal') {
                        loginModal.hidden = true;
                    }
                });
            }
        }
    </script>
</body>

</html>